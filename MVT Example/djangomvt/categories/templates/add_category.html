{% extends 'layout.html' %}

{% block mycontent %}

<h1 class="text-center">Додати категорію</h1>
<div class="row">
    <form class="col-md-12" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="mb-3">
            <label for="name" class="form-label">Назва</label>
            <input type="text" class="form-control" id="name" name="name" required>
        </div>

        <div class="mb-3">
            <label for="image" class="form-label">Головне зображення</label>
            <input type="file" class="form-control" id="image" name="image" accept="image/*">
        </div>

        <div class="mb-3">
            <label for="description">Опис:</label>
            <textarea class="form-control" id="description" name="description" rows="10"></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Додати</button>
        <a href="{% url 'categories:show_categories' %}" class="btn btn-secondary">Скасувати</a>
    </form>
</div>

{% endblock %}

{% block myScripts %}
<script>
    tinymce.init({
        selector: 'textarea',
        plugins: 'anchor autolink charmap codesample emoticons ' +
            'image link lists media searchreplace table visualblocks wordcount',
        toolbar: 'undo redo | blocks fontfamily fontsize | bold italic '+
            'underline strikethrough | link image media table | align '+
            'lineheight | numlist bullist indent outdent | emoticons charmap '+
            '| removeformat',
        automatic_uploads: true,
        images_file_types: "jpg,jpeg,png,webp",
        paste_data_images: true,
        images_upload_url: '{% url "categories:upload_image" %}',
        
        setup: (editor) => {
            editor.on('Paste', async (e) => {
                e.preventDefault();
                const clipboardData = e.clipboardData || e.originalEvent?.clipboardData;
                if (!clipboardData) return;

                const html = clipboardData.getData("text/html");
                const text = clipboardData.getData("text/plain");
                let contentToInsert = html || text;
                if (!contentToInsert) return;

                const temp = document.createElement("div");
                temp.innerHTML = contentToInsert;
                const imgs = Array.from(temp.querySelectorAll("img"));

                for (let img of imgs) {
                    const src = img.getAttribute("src");
                    if (!src || src.startsWith("http://127.0.0.1")) continue;
                    try {
                        const response = await fetch(src);
                        const blob = await response.blob();
                        const formData = new FormData();
                        formData.append('file', blob, 'pasted-image.jpg');
                        
                        const uploadResponse = await fetch('{% url "categories:upload_image" %}', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await uploadResponse.json();
                        img.setAttribute("src", result.location);
                        img.removeAttribute("srcset");
                    } catch (err) {
                        console.error("Failed to upload image:", err);
                    }
                }
                editor.insertContent(temp.innerHTML);
            });
        }
    });
</script>
{% endblock %}